# AHC041 7位解法

高さを状態として焼きなます解法について紹介します。

[提出](https://atcoder.jp/contests/ahc041/submissions/61912817)

## コンテストで問題を読んだ時の考察

- 部分木の親を付け替えたり、木を回転させたりするのが強そうだと思いました。
    - 親の付け替えは[AHC037の自分の解法](https://atcoder.jp/contests/ahc037/submissions/57824394) 解説放送も参考になります。
    - [木の回転 - Wikipedia](https://ja.wikipedia.org/wiki/%E6%9C%A8%E3%81%AE%E5%9B%9E%E8%BB%A2) 本来の問題を特殊化した次の問題「木に用いる辺を固定した時に、どの頂点を値にするべきか」を決定的に解こうとすると全方位木DPがしたくなりました。木の回転で根を焼きなませば、全方位木DPをした気分になれるのでは、という考察から木の回転をするべきだと思いました。
- ただし木構造を直接状態にするのは筋が悪いように感じました。遷移時の高さチェックがかなり重そうに感じたためです。
    - 実は実装を頑張るとこちらの方が点数が出るようです。今回の解説放送を見ましょう。
- 「ある頂点を高さ1にしたい」→「根が隣にあれば良い」=「高さ0が隣にあれば良い」という考察をして、高さを状態にできることに気がつきました。

## 焼きなましの状態の持ち方と復元

- 各頂点iの高さh\_iを状態として持ちます。
- 各頂点iについてh\_i = 0 または h\_i = h\_j + 1となるような隣接点jが存在することが条件です。
- h\_i = 0の場合はiが根となり、h\_i = h\_j + 1はiの親をjにすることで解を復元できます。

## 焼きなましの遷移

1. ランダムな頂点iとその隣接点jを選び、h\_iをh\_j + 1に変化
    - 頂点iの隣接点について、hが解を復元できる条件を満たしているかをチェックします。
2. ランダムな頂点iを選び、h\_iを0に変化 (1とほぼ同じ)
3. ランダムな頂点iとその隣接点jを選び、h\_iとh\_jをswap
    - 頂点i, jそれぞれの隣接点について、hが解を復元できる条件を満たしているかをチェックします。

高速化の工夫として、「頂点iの隣接点であって高さがxであるものは何個あるか」を持つ配列を遷移時に更新するようにすれば、条件のチェックを高速に行うことができます。その配列やhを書き換えることなくチェックすることができるため、それを実装することでも高速化できます。

(要復習: 多分これらは焼きなましの高速化典型で、解説放送の解法も同じような高速化を行っているはずです)

高速化によって、0000.txtについて遷移候補を30807873回試すことができているようです。

## 反省点

解の復元時に辺の方向を逆向きにしていて1時間くらい混乱していました。よくない。

[Jirotechさんの解法](https://atcoder.jp/contests/ahc041/submissions/61871285)がほぼ同じで自分より繊維の種類が多いです。隣接swapをバグらせていた時間が長く、他の遷移を実装する暇がありませんでした... 実装をテキパキやりましょう。
